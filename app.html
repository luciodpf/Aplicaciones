<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#1a2e1a">
<title>Aplicaciones</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Fraunces:ital,opsz,wght@0,9..144,300;0,9..144,600;1,9..144,300&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0f1a0f;
    --bg2: #162216;
    --bg3: #1e2e1e;
    --accent: #7ec850;
    --accent2: #4a8a20;
    --text: #e8f0e0;
    --text2: #9aaa88;
    --text3: #5a6a50;
    --border: #2a3a2a;
    --card: #162216;
    --radius: 12px;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

  body {
    font-family: 'DM Mono', monospace;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* HEADER */
  .header {
    background: var(--bg2);
    border-bottom: 1px solid var(--border);
    padding: 16px 20px 0;
    position: sticky;
    top: 0;
    z-index: 100;
  }

  .header-top {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
  }

  .logo {
    font-family: 'Fraunces', serif;
    font-size: 22px;
    font-weight: 600;
    color: var(--accent);
    letter-spacing: -0.5px;
  }

  .logo span {
    color: var(--text2);
    font-weight: 300;
    font-style: italic;
  }

  .sync-btn {
    background: none;
    border: 1px solid var(--border);
    color: var(--text2);
    padding: 6px 12px;
    border-radius: 20px;
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.2s;
  }

  .sync-btn:hover { border-color: var(--accent); color: var(--accent); }
  .sync-btn.loading .icon { animation: spin 1s linear infinite; }

  @keyframes spin { to { transform: rotate(360deg); } }

  /* TABS */
  .tabs {
    display: flex;
    gap: 0;
  }

  .tab {
    flex: 1;
    text-align: center;
    padding: 10px 8px;
    font-size: 12px;
    color: var(--text3);
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.2s;
    letter-spacing: 0.5px;
    text-transform: uppercase;
  }

  .tab.active {
    color: var(--accent);
    border-bottom-color: var(--accent);
  }

  /* ZONA BAR */
  .zona-bar {
    display: flex;
    gap: 6px;
    padding: 8px 0 12px;
  }

  .zona-btn {
    background: none;
    border: 1px solid var(--border);
    color: var(--text3);
    padding: 5px 14px;
    border-radius: 20px;
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    cursor: pointer;
    transition: all 0.2s;
    letter-spacing: 0.3px;
  }

  .zona-btn.active {
    background: rgba(126,200,80,0.12);
    border-color: var(--accent);
    color: var(--accent);
  }

  /* MAIN */
  .main {
    padding: 16px;
    max-width: 500px;
    margin: 0 auto;
  }

  /* STATS BAR */
  .stats-bar {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 8px;
    margin-bottom: 20px;
  }

  .stat-card {
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 12px;
    text-align: center;
  }

  .stat-num {
    font-family: 'Fraunces', serif;
    font-size: 24px;
    font-weight: 600;
    color: var(--accent);
    line-height: 1;
  }

  .stat-label {
    font-size: 9px;
    color: var(--text3);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-top: 4px;
  }

  /* FILTER */
  .filter-row {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
    align-items: center;
  }

  .filter-select {
    flex: 1;
    background: var(--bg3);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 10px 14px;
    border-radius: 8px;
    font-family: 'DM Mono', monospace;
    font-size: 12px;
    appearance: none;
    -webkit-appearance: none;
    cursor: pointer;
  }

  .filter-select:focus { outline: none; border-color: var(--accent); }

  .filter-wrap { position: relative; flex: 1; }
  .filter-wrap::after {
    content: '‚ñæ';
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text3);
    pointer-events: none;
    font-size: 10px;
  }

  /* MONTH NAV */
  .month-nav {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 8px 4px;
  }

  .month-btn {
    background: none;
    border: none;
    color: var(--text2);
    font-size: 18px;
    cursor: pointer;
    padding: 4px 14px;
    transition: color 0.2s;
  }

  .month-btn:hover { color: var(--accent); }

  .month-label {
    font-family: 'Fraunces', serif;
    font-size: 16px;
    font-weight: 600;
    color: var(--text);
    text-transform: capitalize;
  }

  /* APPLICATION CARD */
  .app-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    margin-bottom: 10px;
    overflow: hidden;
    cursor: pointer;
    transition: border-color 0.2s, transform 0.15s;
  }

  .app-card:active { transform: scale(0.99); }
  .app-card:hover { border-color: var(--accent2); }
  .app-card.expanded { border-color: var(--accent); }

  .card-main {
    padding: 14px 16px;
    display: flex;
    align-items: flex-start;
    gap: 12px;
  }

  .card-date-block {
    background: var(--bg3);
    border-radius: 8px;
    padding: 6px 10px;
    text-align: center;
    min-width: 48px;
    flex-shrink: 0;
  }

  .card-day {
    font-family: 'Fraunces', serif;
    font-size: 22px;
    font-weight: 600;
    color: var(--accent);
    line-height: 1;
  }

  .card-month-short {
    font-size: 9px;
    color: var(--text3);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .card-info { flex: 1; min-width: 0; }

  .card-campo {
    font-family: 'Fraunces', serif;
    font-size: 17px;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 3px;
  }

  .card-lote {
    font-size: 11px;
    color: var(--text2);
    margin-bottom: 6px;
  }

  .card-tags {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
  }

  .tag {
    font-size: 10px;
    padding: 3px 8px;
    border-radius: 20px;
    letter-spacing: 0.3px;
  }

  .tag-has {
    background: rgba(126, 200, 80, 0.12);
    color: var(--accent);
    border: 1px solid rgba(126, 200, 80, 0.25);
  }

  .tag-zona {
    background: rgba(255,255,255,0.04);
    color: var(--text3);
    border: 1px solid var(--border);
  }

  .tag-prod {
    background: rgba(255,255,255,0.04);
    color: var(--text2);
    border: 1px solid var(--border);
  }

  /* EXPANDED DETAIL */
  .card-detail {
    display: none;
    border-top: 1px solid var(--border);
    padding: 12px 16px;
  }

  .app-card.expanded .card-detail { display: block; }

  .detail-title {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    color: var(--text3);
    margin-bottom: 8px;
  }

  .product-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 7px 0;
    border-bottom: 1px solid var(--border);
    gap: 8px;
  }

  .product-row:last-child { border-bottom: none; }

  .product-name {
    font-size: 12px;
    color: var(--text);
    flex: 1;
  }

  .product-qty {
    font-size: 11px;
    color: var(--accent);
    white-space: nowrap;
  }

  /* CAMPO VIEW */
  .campo-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    margin-bottom: 20px;
  }

  .campo-chip {
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
  }

  .campo-chip:hover, .campo-chip.selected {
    border-color: var(--accent);
    background: rgba(126, 200, 80, 0.08);
  }

  .campo-chip-name {
    font-family: 'Fraunces', serif;
    font-size: 14px;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 3px;
  }

  .campo-chip-count {
    font-size: 10px;
    color: var(--text3);
  }

  /* LOADING */
  .loading-screen {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 60vh;
    gap: 16px;
  }

  .loading-logo {
    font-family: 'Fraunces', serif;
    font-size: 36px;
    color: var(--accent);
    opacity: 0;
    animation: fadeIn 0.5s 0.2s forwards;
  }

  .loading-dots {
    display: flex;
    gap: 8px;
  }

  .loading-dot {
    width: 6px;
    height: 6px;
    background: var(--accent);
    border-radius: 50%;
    animation: pulse 1.2s ease-in-out infinite;
  }

  .loading-dot:nth-child(2) { animation-delay: 0.2s; }
  .loading-dot:nth-child(3) { animation-delay: 0.4s; }

  @keyframes pulse {
    0%, 80%, 100% { opacity: 0.2; transform: scale(0.8); }
    40% { opacity: 1; transform: scale(1); }
  }

  @keyframes fadeIn { to { opacity: 1; } }

  .empty-state {
    text-align: center;
    padding: 40px 20px;
    color: var(--text3);
  }

  .empty-icon { font-size: 40px; margin-bottom: 12px; }
  .empty-text { font-size: 13px; line-height: 1.6; }

  /* ERROR */
  .error-banner {
    background: rgba(200, 80, 80, 0.15);
    border: 1px solid rgba(200, 80, 80, 0.3);
    color: #e88;
    padding: 12px 16px;
    border-radius: 8px;
    font-size: 12px;
    margin-bottom: 16px;
    line-height: 1.5;
  }

  /* SECTION HEADER */
  .section-header {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--text3);
    margin: 20px 0 10px;
    padding-bottom: 6px;
    border-bottom: 1px solid var(--border);
  }

  .section-header:first-child { margin-top: 0; }

  .back-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    background: none;
    border: 1px solid var(--border);
    color: var(--text2);
    padding: 8px 14px;
    border-radius: 8px;
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    cursor: pointer;
    margin-bottom: 16px;
    transition: all 0.2s;
  }

  .back-btn:hover { border-color: var(--accent); color: var(--accent); }
</style>
</head>
<body>

<div id="loading" class="loading-screen">
  <div class="loading-logo">üå± Campo</div>
  <div class="loading-dots">
    <div class="loading-dot"></div>
    <div class="loading-dot"></div>
    <div class="loading-dot"></div>
  </div>
</div>

<div id="app" style="display:none">
  <div class="header">
    <div class="header-top">
      <div class="logo">Campo <span>aplicaciones</span></div>
      <button class="sync-btn" onclick="syncData()">
        <span class="icon">‚Üª</span> Actualizar
      </button>
    </div>
    <div class="tabs">
      <div class="tab active" onclick="setTab('mes')" id="tab-mes">Este mes</div>
      <div class="tab" onclick="setTab('campo')" id="tab-campo">Por campo</div>
    </div>
    <div class="zona-bar">
      <button class="zona-btn active" onclick="setZona('todas')" id="zona-todas">Todas</button>
      <button class="zona-btn" onclick="setZona('Sur')" id="zona-sur">Sur</button>
      <button class="zona-btn" onclick="setZona('Norte')" id="zona-norte">Norte</button>
    </div>
  </div>

  <div class="main" id="main-content"></div>
</div>

<script>
const SHEET_ID = '1jfk3SU0AR4aT9po5DtSv4_-GUs9vFnUHGKkBZtdMwqw';
const SHEET_NAME = 'Aplicaciones';
const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(SHEET_NAME)}`;

// Campos zona norte
const CAMPOS_NORTE = ['salera','mondino','bertolini','cibalero','gazano'];

let allData = [];
let currentTab = 'mes';
let currentMonth = new Date().getMonth();
let currentYear = new Date().getFullYear();
let selectedCampo = null;
let currentZona = 'todas'; // 'todas', 'Sur', 'Norte'

const MESES = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
const MESES_CORTO = ['ENE','FEB','MAR','ABR','MAY','JUN','JUL','AGO','SEP','OCT','NOV','DIC'];

function parseCSV(text) {
  const lines = text.trim().split('\n');
  const rows = [];
  for (let i = 1; i < lines.length; i++) {
    const cols = parseCSVLine(lines[i]);
    if (cols.length < 8) continue;
    const fechaStr = cols[0]?.replace(/"/g,'').trim();
    if (!fechaStr) continue;
    const fecha = parseDate(fechaStr);
    if (!fecha) continue;
    rows.push({
      fecha,
      fechaStr,
      campo: cols[2]?.replace(/"/g,'').trim() || '',
      lote: cols[3]?.replace(/"/g,'').trim() || '',
      zonaRaw: cols[4]?.replace(/"/g,'').trim() || '',
      get zona() { return this.zonaRaw || getZonaCampo(this.campo); },
      superficie: parseFloat(cols[6]?.replace(/"/g,'').replace(',','.')) || 0,
      insumo: cols[7]?.replace(/"/g,'').trim() || '',
      cantidad: parseFloat(cols[9]?.replace(/"/g,'').replace(',','.')) || 0,
    });
  }
  return rows;
}

function parseCSVLine(line) {
  const result = [];
  let current = '';
  let inQuotes = false;
  for (let i = 0; i < line.length; i++) {
    if (line[i] === '"') {
      inQuotes = !inQuotes;
    } else if (line[i] === ',' && !inQuotes) {
      result.push(current);
      current = '';
    } else {
      current += line[i];
    }
  }
  result.push(current);
  return result;
}

function parseDate(str) {
  if (!str) return null;
  // DD/MM/YYYY or DD/MM/YY
  const parts = str.split('/');
  if (parts.length === 3) {
    let [d, m, y] = parts;
    if (y.length === 2) y = '20' + y;
    const date = new Date(parseInt(y), parseInt(m) - 1, parseInt(d));
    if (!isNaN(date.getTime())) return date;
  }
  return null;
}

function groupApplications(rows) {
  const groups = {};
  for (const row of rows) {
    const key = `${row.fechaStr}||${row.campo}||${row.lote}`;
    if (!groups[key]) {
      groups[key] = {
        fecha: row.fecha,
        fechaStr: row.fechaStr,
        campo: row.campo,
        lote: row.lote,
        zona: row.zona,
        superficie: row.superficie,
        productos: []
      };
    }
    if (row.insumo) {
      groups[key].productos.push({ nombre: row.insumo, cantidad: row.cantidad });
    }
  }
  return Object.values(groups).sort((a, b) => b.fecha - a.fecha);
}

async function fetchData() {
  const resp = await fetch(CSV_URL);
  if (!resp.ok) throw new Error('No se pudo cargar la planilla');
  const text = await resp.text();
  return parseCSV(text);
}

async function syncData() {
  const btn = document.querySelector('.sync-btn');
  btn.classList.add('loading');
  try {
    allData = await fetchData();
    render();
  } catch(e) {
    document.getElementById('main-content').innerHTML = `
      <div class="error-banner">
        ‚ö†Ô∏è No se pudo cargar la planilla.<br>
        Verific√° tu conexi√≥n a internet.<br><small>${e.message}</small>
      </div>`;
  }
  btn.classList.remove('loading');
}

function setZona(zona) {
  currentZona = zona;
  document.querySelectorAll('.zona-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('zona-' + zona.toLowerCase()).classList.add('active');
  selectedCampo = null;
  render();
}

function setTab(tab) {
  currentTab = tab;
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById('tab-' + tab).classList.add('active');
  selectedCampo = null;
  render();
}

function render() {
  if (currentTab === 'mes') renderMes();
  else renderCampo();
}

function renderMes() {
  const filtered = allData.filter(r =>
    r.fecha.getMonth() === currentMonth && r.fecha.getFullYear() === currentYear &&
    (currentZona === 'todas' || r.zona === currentZona)
  );
  const groups = groupApplications(filtered);

  const totalHas = groups.reduce((s, g) => s + g.superficie, 0);
  const totalAplicaciones = groups.length;
  const campos = new Set(groups.map(g => g.campo)).size;

  let html = `
    <div class="month-nav">
      <button class="month-btn" onclick="changeMonth(-1)">‚Äπ</button>
      <div class="month-label">${MESES[currentMonth]} ${currentYear}</div>
      <button class="month-btn" onclick="changeMonth(1)">‚Ä∫</button>
    </div>
    <div class="stats-bar">
      <div class="stat-card">
        <div class="stat-num">${totalHas.toLocaleString('es-AR', {maximumFractionDigits:0})}</div>
        <div class="stat-label">Hect√°reas</div>
      </div>
      <div class="stat-card">
        <div class="stat-num">${totalAplicaciones}</div>
        <div class="stat-label">Aplicaciones</div>
      </div>
      <div class="stat-card">
        <div class="stat-num">${campos}</div>
        <div class="stat-label">Campos</div>
      </div>
    </div>
  `;

  if (groups.length === 0) {
    html += `<div class="empty-state">
      <div class="empty-icon">üåæ</div>
      <div class="empty-text">No hay aplicaciones en<br>${MESES[currentMonth]} ${currentYear}</div>
    </div>`;
  } else {
    // Agrupar por fecha para section headers
    let lastDate = null;
    for (const g of groups) {
      const dateLabel = `${g.fecha.getDate()} de ${MESES[g.fecha.getMonth()]}`;
      if (dateLabel !== lastDate) {
        html += `<div class="section-header">${dateLabel}</div>`;
        lastDate = dateLabel;
      }
      html += renderCard(g);
    }
  }

  document.getElementById('main-content').innerHTML = html;
}

function renderCampo() {
  if (!selectedCampo) {
    // Mostrar grilla de campos
    const camposMap = {};
    const dataZona = currentZona === 'todas' ? allData : allData.filter(r => r.zona === currentZona);
    for (const r of dataZona) {
      if (!camposMap[r.campo]) camposMap[r.campo] = 0;
      camposMap[r.campo]++;
    }
    const campos = Object.keys(camposMap).sort();

    let html = `<div class="campo-grid">`;
    for (const c of campos) {
      const count = groupApplications(dataZona.filter(r => r.campo === c)).length;
      html += `<div class="campo-chip" onclick="selectCampo('${c.replace(/'/g,"\\'")}')">
        <div class="campo-chip-name">${c}</div>
        <div class="campo-chip-count">${count} aplic.</div>
      </div>`;
    }
    html += `</div>`;
    document.getElementById('main-content').innerHTML = html;
  } else {
    const filtered = allData.filter(r => r.campo === selectedCampo && (currentZona === 'todas' || r.zona === currentZona));
    const groups = groupApplications(filtered);
    const totalHas = groups.reduce((s, g) => s + g.superficie, 0);

    let html = `
      <button class="back-btn" onclick="selectedCampo=null;render()">‚Üê Todos los campos</button>
      <div class="stats-bar" style="grid-template-columns:1fr 1fr;margin-bottom:16px">
        <div class="stat-card">
          <div class="stat-num">${totalHas.toLocaleString('es-AR',{maximumFractionDigits:0})}</div>
          <div class="stat-label">Has. totales</div>
        </div>
        <div class="stat-card">
          <div class="stat-num">${groups.length}</div>
          <div class="stat-label">Aplicaciones</div>
        </div>
      </div>
    `;

    let lastMonth = null;
    for (const g of groups) {
      const monthLabel = `${MESES[g.fecha.getMonth()]} ${g.fecha.getFullYear()}`;
      if (monthLabel !== lastMonth) {
        html += `<div class="section-header">${monthLabel}</div>`;
        lastMonth = monthLabel;
      }
      html += renderCard(g);
    }

    document.getElementById('main-content').innerHTML = html;
  }
}

function renderCard(g) {
  const day = g.fecha.getDate().toString().padStart(2,'0');
  const mon = MESES_CORTO[g.fecha.getMonth()];
  const loteText = g.lote && g.lote !== '1' ? `Lote ${g.lote}` : '';
  const prodCount = g.productos.length;

  const productosHTML = g.productos.map(p =>
    `<div class="product-row">
      <div class="product-name">${p.nombre}</div>
      <div class="product-qty">${p.cantidad > 0 ? p.cantidad.toLocaleString('es-AR') : ''}</div>
    </div>`
  ).join('');

  return `<div class="app-card" onclick="toggleCard(this)">
    <div class="card-main">
      <div class="card-date-block">
        <div class="card-day">${day}</div>
        <div class="card-month-short">${mon}</div>
      </div>
      <div class="card-info">
        <div class="card-campo">${g.campo}</div>
        ${loteText ? `<div class="card-lote">${loteText}</div>` : ''}
        <div class="card-tags">
          <span class="tag tag-has">${g.superficie} has</span>
          <span class="tag tag-zona">${g.zona || '‚Äî'}</span>
          <span class="tag tag-prod">${prodCount} ${prodCount === 1 ? 'producto' : 'productos'}</span>
        </div>
      </div>
    </div>
    <div class="card-detail">
      <div class="detail-title">Productos aplicados</div>
      ${productosHTML}
    </div>
  </div>`;
}

function toggleCard(el) {
  el.classList.toggle('expanded');
}

function changeMonth(dir) {
  currentMonth += dir;
  if (currentMonth < 0) { currentMonth = 11; currentYear--; }
  if (currentMonth > 11) { currentMonth = 0; currentYear++; }
  render();
}

function selectCampo(nombre) {
  selectedCampo = nombre;
  render();
}

// INIT
(async () => {
  try {
    allData = await fetchData();
    document.getElementById('loading').style.display = 'none';
    document.getElementById('app').style.display = 'block';
    render();
  } catch(e) {
    document.getElementById('loading').innerHTML = `
      <div style="text-align:center;padding:20px">
        <div style="font-size:30px;margin-bottom:12px">‚ö†Ô∏è</div>
        <div style="color:#e88;font-size:13px">No se pudo cargar la planilla.<br>Verific√° la conexi√≥n.</div>
        <button onclick="location.reload()" style="margin-top:16px;background:var(--accent2);color:white;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-family:'DM Mono',monospace">Reintentar</button>
      </div>`;
  }
})();
</script>
</body>
</html>
